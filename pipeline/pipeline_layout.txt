================================================================================
        5-STAGE PIPELINED RISC-V DATAPATH FOR TRAFFIC CONTROLLER
================================================================================

                        INSTRUCTION FETCH (IF)
    ┌─────────────────────────────────────────────────────────────┐
    │  ┌──────┐      ┌──────────┐         ┌──────────────┐        │
    │  │  PC  │─────▶│  I-Cache │────────▶│ Instruction  │       │
    │  └──┬───┘      └──────────┘         │   Register   │        │
    │     │               ▲                └──────┬───────┘       │
    │     │          [Tag|Set|Offset]            │                │
    │     └──────┐                                │                │
    │         +4 │   [Hit/Miss Logic]             │                │
    └────────────┼────────────────────────────────┼────────────────┘
                 │                                │
                 │                                ▼
              ┌──┴───┐                    ╔═══════════════╗
              │ Adder│                    ║   IF/ID Reg   ║
              └──────┘                    ╚═══════┬═══════╝
                                                  │
    ─────────────────────────────────────────────┼─────────────────
                                                  │
                     INSTRUCTION DECODE (ID)      │
    ┌─────────────────────────────────────────────┼────────────────┐
    │                                              ▼                │
    │  ┌──────────────┐      ┌─────────────────────────┐           │
    │  │   Control    │      │    Register File        │           │
    │  │    Unit      │      │  ┌────┐  ┌────┐         │           │
    │  └──────┬───────┘      │  │ R1 │  │ R2 │  32×32  │           │
    │         │              │  └──┬─┘  └──┬─┘         │           │
    │    [RegWrite,          │     │       │           │           │
    │     MemRead,           └─────┼───────┼───────────┘           │
    │     MemWrite,                │       │                       │
    │     ALUOp, etc]              │       │                       │
    │         │              ┌─────▼───────▼──────┐                │
    │         │              │  Hazard Detection  │                │
    │         │              │      Unit          │                │
    │         │              │ [Load-Use Stall]   │                │
    │         │              └────────────────────┘                │
    └─────────┼──────────────────────────────────────────────────┐ │
              │                                                   │ │
              │                          ╔═══════════════════╗   │ │
              └─────────────────────────▶║   ID/EX Register  ║◀──┘ │
                                         ╚═══════┬═══════════╝     │
    ─────────────────────────────────────────────┼─────────────────┘
                                                  │
                          EXECUTE (EX)            │
    ┌─────────────────────────────────────────────┼────────────────┐
    │                                              ▼                │
    │                          ┌─────────────────────────┐          │
    │     ┌───────────────────▶│    Forwarding Unit      │          │
    │     │                    │  [EX/MEM, MEM/WB Data]  │          │
    │     │                    └──────────┬──────────────┘          │
    │     │                               │                         │
    │     │                     ┌─────────▼──────────┐              │
    │     │      Operand A ────▶│                    │              │
    │     │                     │     64-bit ALU     │              │
    │     │      Operand B ────▶│  [+, -, &, |, <<]  │              │
    │     │                     │                    │              │
    │     │                     └──────────┬─────────┘              │
    │     │                                │                        │
    │     │                     ┌──────────▼─────────┐              │
    │     │                     │  Branch Resolution │              │
    │     │                     │   [Zero, LessThan] │              │
    │     │                     └──────────┬─────────┘              │
    │     │                                │                        │
    │     │                         [Branch Taken?]                 │
    │     │                                │                        │
    │     │                                ├───▶ [Flush IF/ID]      │
    │     │                                │                        │
    └─────┼────────────────────────────────┼────────────────────────┘
          │                                │
          │              ╔═════════════════╩═══════╗
          │              ║    EX/MEM Register      ║
          │              ╚═════════════╤═══════════╝
          │                            │
    ──────┼────────────────────────────┼────────────────────────────
          │                            │
          │             MEMORY (MEM)   │
    ┌─────┼────────────────────────────┼────────────────────────────┐
    │     │                            ▼                            │
    │     │              ┌─────────────────────────┐                │
    │     │              │       D-Cache           │                │
    │     │              │  [16KB, 2-way, 64B]     │                │
    │     │              │                         │                │
    │     │              │  ┌─────┐  ┌─────┐      │                │
    │     │   Address───▶│  │ Way0│  │ Way1│      │                │
    │     │              │  └─────┘  └─────┘      │                │
    │     │   WriteData─▶│                        │                │
    │     │              │  [LRU Replacement]     │                │
    │     │              └──────────┬──────────────┘                │
    │     │                         │                               │
    │     │                  [Read Data/                            │
    │     │                   Write-Back]                           │
    │     │                         │                               │
    └─────┼─────────────────────────┼───────────────────────────────┘
          │                         │
          │       ╔═════════════════╩════════╗
          └──────▶║   MEM/WB Register        ║
                  ╚═════════════╤════════════╝
                                │
    ────────────────────────────┼────────────────────────────────────
                                │
                    WRITE BACK (WB)
    ┌───────────────────────────┼────────────────────────────────────┐
    │                           ▼                                    │
    │              ┌─────────────────────────┐                       │
    │              │      MUX (2:1)          │                       │
    │              │  [ALU Result / MemData] │                       │
    │              └──────────┬──────────────┘                       │
    │                         │                                      │
    │                         │ Write Data                           │
    │                         │                                      │
    │                         ▼                                      │
    │              ┌─────────────────────────┐                       │
    │              │   Register File         │                       │
    │              │   (Write Port)          │                       │
    │              └─────────────────────────┘                       │
    │                         ▲                                      │
    │                         │                                      │
    │                  [RegWrite Signal]                             │
    └────────────────────────────────────────────────────────────────┘

================================================================================
                        HAZARD HANDLING MECHANISMS
================================================================================

1. DATA HAZARDS (RAW - Read After Write)
   ┌────────────────────────────────────────────────────────────┐
   │ Forwarding Paths:                                          │
   │  • EX/MEM.ALUResult ──┐                                    │
   │                       ├──▶ EX Stage (ALU inputs)           │
   │  • MEM/WB.Result ─────┘                                    │
   │                                                             │
   │ Load-Use Hazard:                                           │
   │  • Detect: ID stage reads reg that MEM is loading          │
   │  • Action: Stall pipeline 1 cycle, insert bubble           │
   └────────────────────────────────────────────────────────────┘

2. CONTROL HAZARDS (Branches)
   ┌────────────────────────────────────────────────────────────┐
   │ Strategy: Predict Not Taken                                │
   │  • Continue fetching PC+4                                  │
   │  • If branch taken (resolved in EX):                       │
   │    - Flush IF/ID and ID/EX stages                          │
   │    - Update PC to branch target                            │
   │  • Penalty: 2 cycles                                       │
   └────────────────────────────────────────────────────────────┘

================================================================================
                    KEY ANNOTATIONS AND SPECIFICATIONS
================================================================================

Pipeline Registers:
  IF/ID:   {PC+4, Instruction}
  ID/EX:   {PC+4, ReadData1, ReadData2, Imm, Funct, Rd, Control Signals}
  EX/MEM:  {BranchTarget, ALUResult, WriteData, Rd, MemWrite, MemRead, RegWrite}
  MEM/WB:  {ReadData, ALUResult, Rd, RegWrite, MemToReg}

Control Signals (Generated in ID):
  • RegWrite, MemRead, MemWrite
  • MemToReg, ALUSrc, ALUOp
  • Branch, Jump

Cache Specifications:
  I-Cache: 16KB, direct-mapped, 64B blocks
  D-Cache: 16KB, 2-way set assoc, 64B blocks, LRU, write-back

Performance (Traffic Controller):
  • Instructions: 21 per loop
  • Cycles: 26 (CPI = 1.24)
  • Stalls: 1 (load-use)
  • Flushes: 4 (2 branches × 2)

================================================================================
